---
title: "Class blog 5"
subtitle: "Mergede dataset "
author: "Yating Zhu, Dingyu Guo, Suh Edwin Jiho, Wang Muxi"
date: "2024-04-12"
date-modified: "2024-04-12"
draft: FALSE
---
Previously, we investigate the relationship between rent spending and income. In this blog, we merged the dataset from 2000 to 2022, to get a further insight on the trend of the rent in these twenty years. 
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyr)
library(broom)
library(dplyr)
library(here)
library(gt)
library(purrr)
data_path <- here("dataset", "twentyyear_rent.csv")
library(readr)
data_twenty <- read_csv(data_path,show_col_types = FALSE) 
library(ggplot2)
library(knitr)
```
## Visualize the pattern in 22 yrs 
### Rent trend 
```{r echo=FALSE, message=FALSE, warning=FALSE}
annual_median_rent <- data_twenty %>%
  group_by(YEAR) %>%
  summarize(MedianRent = median(RENTGRS, na.rm = TRUE))

ggplot(annual_median_rent, aes(x = YEAR, y = MedianRent)) +
  geom_line(size=1.2, color="#95A5A6") + 
  geom_point(size=1.5, color="#3498DB", shape=21, fill="#3498DB") +  
  theme_minimal(base_size = 15) +  
  theme(
    plot.title = element_text(hjust = 0.5, size=15, face="bold", color="#34495E"), 
    axis.title = element_text(size=10, face="bold", color="#34495E"),  
    axis.text = element_text(color="#34495E"), 
    panel.grid.major = element_line(color="#ECF0F1", size=0.2),  
    panel.grid.minor = element_blank(), 
    legend.position = "none",
    plot.margin = margin(5.5, 5.5, 5.5, 5.5, "mm")
  ) +
  labs(
    title = "Trend of Median Rent Over the Years",
    x = "Year",
    y = "Median Gross Rent",
    caption = "Data Source: IPUMS"  
  )
```
- The chart displays the trend of median gross rent from the early 2000s to the early 2020s, give a general view of the change on gross rent in 20 years. 
- Median values are used to represent the data to mitigate the effects of large outliers on the analysis, as explored in class blog 3.
- There is a clear and steady increase in the median gross rent over the years, indicating a consistent rise in rental costs.
- No periods of decline or stagnation are visible, suggesting a persistent demand for housing or other market pressures driving up rent.

### Income trend
```{r echo=FALSE, message=FALSE, warning=FALSE}
annual_median_income <- data_twenty %>%
  group_by(YEAR) %>%
  summarize(MedianIncome = median(INCTOT, na.rm = TRUE))
ggplot(annual_median_income, aes(x = YEAR, y = MedianIncome)) +
  geom_line(size=1.2, color="#95A5A6") + 
  geom_point(size=1.5, color="#3498DB", shape=21, fill="#3498DB") + 
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(hjust = 0.5, size=15, face="bold", color="#34495E"),
    axis.title = element_text(size=10, face="bold", color="#34495E"),
    axis.text = element_text(color="#34495E"),
    panel.grid.major = element_line(color="#ECF0F1", size=0.2),
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.margin = margin(5.5, 5.5, 5.5, 5.5, "mm")
  ) +
  labs(
    title = "Trend of Median Personal Income Over the Years",
    x = "Year",
    y = "Median Gross Personal Income",
    caption = "Data Source: IPUMS"
  )
```
- The plot shows a rising trend in median personal income from 2000 to 2020.
- Income levels appear to remain relatively stable in the early 2000s, with minimal fluctuation.
- Around 2010, there is a noticeable dip, which could correspond to the after-effects of the 2008 financial crisis.
- Following the dip, there is a strong upward trend, with income levels significantly rising, especially post-2015.
- The steepest increase in median income occurs in the last few years of the data, suggesting a recent boost in personal income levels.

## Group by YEAR, fit same log-log model like 2022 in class blog 4
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Filter out non-positive values before log transformation
data_twenty_positive <- data_twenty[data_twenty$RENTGRS > 0 & data_twenty$INCTOT > 0, ]

# Apply log transformation correctly
data_twenty_positive$log_RENTGRS <- log(data_twenty_positive$RENTGRS)
data_twenty_positive$log_INCTOT <- log(data_twenty_positive$INCTOT)

# Calculating means and standard deviations for the log-transformed columns
mean_log_RENTGRS <- mean(data_twenty_positive$log_RENTGRS, na.rm = TRUE)
sd_log_RENTGRS <- sd(data_twenty_positive$log_RENTGRS, na.rm = TRUE)
mean_log_INCTOT <- mean(data_twenty_positive$log_INCTOT, na.rm = TRUE)
sd_log_INCTOT <- sd(data_twenty_positive$log_INCTOT, na.rm = TRUE)

# Defining lower and upper bounds for both variables
lb_log_RENTGRS <- mean_log_RENTGRS - 3 * sd_log_RENTGRS
ub_log_RENTGRS <- mean_log_RENTGRS + 3 * sd_log_RENTGRS
lb_log_INCTOT <- mean_log_INCTOT - 3 * sd_log_INCTOT
ub_log_INCTOT <- mean_log_INCTOT + 3 * sd_log_INCTOT

# Filter for normal range values
data_clean <- data_twenty_positive %>%
  filter(log_RENTGRS >= lb_log_RENTGRS & log_RENTGRS <= ub_log_RENTGRS,
         log_INCTOT >= lb_log_INCTOT & log_INCTOT <= ub_log_INCTOT) %>%
  filter(complete.cases(KITCHEN, ROOMS, NFAMS, AGE, MARST, RACE, EMPSTAT, REGION_CLASSIFIED)) %>%
  filter_all(all_vars(!is.infinite(.)))
write_csv(data_clean, file = here("dataset", "data_twenty_clean.csv"))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
models_by_year <- data_clean %>%
  group_by(YEAR) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(log_RENTGRS ~ log_INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + REGION_CLASSIFIED, data = .)),
    tidied = map(model, tidy),
    glance_data = map(model, glance),
    augmented = map(model, augment)
  ) %>%
  ungroup()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
models_by_year_1 <- models_by_year %>%
  select(YEAR, tidied) %>%
  unnest(tidied) %>%
  arrange(YEAR)

models_by_year_2 <- models_by_year %>%
  select(YEAR, glance_data) %>%
  unnest(glance_data) %>%
  arrange(YEAR)
kable(models_by_year_2)

models_by_year_3 <- models_by_year %>%
  select(YEAR, augmented) %>%
  unnest(augmented) %>%
  arrange(YEAR)
```
- The r.squared values across the years fluctuate but generally stay within a narrow range, suggesting a consistent level of variability in the response variable that is explained by the model.

- The adj.r.squared values are consistently slightly lower than the r.squared values, which is expected as they adjust for the number of predictors in the model relative to the number of observations. But generally, both of these indicators are in a acceptable range. 

- The p.value column shows zeros across all years, indicating that the overall model is statistically significant each year.

- The logLik (log-likelihood) values are negative and increase in magnitude over time, possibly indicating that the model's fit is improving or that the variability in the data is increasing.

- The AIC and BIC values also generally increase over time, which could suggest that the complexity of the model or the information loss is growing.

- The deviance shows how much of the total variability is not explained by the model; the trends here are not immediately clear without further context.

- he df.residual (degrees of freedom of residuals) decreases slightly over time, indicating that there might be more parameters in the model or less data available in later years.


```{r echo=FALSE, message=FALSE, warning=FALSE}
models_by_year %>%
  unnest(tidied) %>%
  filter(term == "log_INCTOT") %>%
  ggplot(aes(x = as.numeric(YEAR), y = estimate)) +
  geom_line() +
  geom_point() +
  labs(title = "Trend of Coefficient for log_INCTOT Over Years",
       x = "Year",
       y = "Coefficient Estimate")
```
- The coefficient for log_INCTOT has fluctuated over the years, indicating varying degrees of association between INCTOT and the dependent variable in the model.

- There are some years where the coefficient estimate peaks sharply, particularly noticeable in the early 2000s and again around 2020.

- Conversely, there are troughs that follow these peaks, suggesting periods of less influence or a negative correction in the relationship.

- The trend is not monotonic; it does not consistently increase or decrease but rather has multiple peaks and valleys.

- The repeated rise and fall of the coefficient estimate could imply a cyclical pattern that repeats over several years.

- The range of the coefficient estimates is relatively tight, with the lowest around 0.12 and the highest just above 0.14.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Visualizing R-squared trends
models_by_year %>%
  unnest(glance_data) %>%
  ggplot(aes(x = as.numeric(YEAR), y = r.squared)) +
  geom_line() +
  geom_point() +
  labs(title = "Trend of R-squared Over Years",
       x = "Year",
       y = "R-squared")
```
- Like the previous plot for log_INCTOT coefficients, the R-squared values here also show variability over time with no clear or consistent trend.

- The R-squared values represent the proportion of the variance for the dependent variable that's explained by the independent variables in the model. The fluctuation suggests that the model's explanatory power changes from year to year.

- Notably, there's a sharp drop in the R-squared value in the most recent year shown, which could indicate a sudden decrease in the model's predictive power or a significant change in the underlying data structure for these years. 




