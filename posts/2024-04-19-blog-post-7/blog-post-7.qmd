---
title: "Blog Post 7"
author: "Yating Zhu, Dingyu Guo, Suh Edwin Jiho, Wang Muxi"
date: "2024-04-19"
date-modified: "2024-04-19"
draft: FALSE
---
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyr)
library(broom)
library(dplyr)
library(here)
library(gt)
library(purrr)
data_path <- here("dataset", "data_twenty_clean.csv")
data_path1 <- here("dataset", "latest_clean.csv")
library(readr)
data_twenty <- read_csv(data_path,show_col_types = FALSE) 
data_2022 <- read_csv(data_path1,show_col_types = FALSE) 
library(ggplot2)
library(knitr)
library(lme4)
library(broom.mixed)
```

# Time series model
```{r echo=FALSE, message=FALSE, warning=FALSE}
model <- lmer(RENTGRS ~ ROOMS + NFAMS + AGE + (1 | REGION), data = data_twenty, REML = FALSE)

model_with_income <- lmer(RENTGRS ~ ROOMS + NFAMS + AGE + INCTOT + (1 | REGION), data = data_twenty, REML = FALSE)
```

- Fit a time series model using data from 2000 to 2022. 
- 
## Summary table 
```{r}
model_glance <- broom.mixed::glance(model)

model_tidy <- broom.mixed::tidy(model)

model_augment <- broom.mixed::augment(model)
```

```{r}
print(model_glance)
print(model_tidy)
print(head(model_augment))
```
## Residual plot 
```{r}
plot(residuals(model))
```


```{r}
data_twenty$fitted <- predict(model, re.form = NA)
yearly_trends <- data_twenty %>%
  group_by(YEAR) %>%
  summarise(Average_Fitted = mean(fitted))

ggplot(yearly_trends, aes(x = YEAR, y = Average_Fitted)) +
  geom_line() +
  labs(title = "Time Series Plot of Fitted Rent Values by Year",
       x = "Year",
       y = "Average Fitted Rent") +
  theme_minimal()
```

- The linear mixed-effects model assesses the impact of rooms, family size, and age on rent prices.
- Random effects account for region-based variations.
- The model summary indicates the significance and impact of each factor on rent prices.
- The residual plot reveals:
  1) Residuals are widely dispersed around zero, suggesting no systematic bias in the model.
  2) Some outliers are present, which could be anomalies.
- The time series plot of fitted values shows:
  1) Fluctuating average fitted rent values over the years.
  2) An increasing trend in rent prices up to 2015.
  3) A post-2015 sharp decline in average fitted rent values.
- Potential causes for trends:
  1) Pre-2015 rise could relate to inflation, market demand, or changes in building age, room number, and family size.
  2) The decline after 2015 might reflect economic events, policy changes, or factors outside the model's scope.



```{r}
data_twenty$INCTOT <- scale(data_twenty$INCTOT, center = TRUE, scale = TRUE)
data_twenty$ROOMS <- scale(data_twenty$ROOMS, center = TRUE, scale = TRUE)
data_twenty$NFAMS <- scale(data_twenty$NFAMS, center = TRUE, scale = TRUE)
data_twenty$AGE <- scale(data_twenty$AGE, center = TRUE, scale = TRUE)
data_twenty$FTOTINC <- scale(data_twenty$FTOTINC, center = TRUE, scale = TRUE)

model_with_income <- lmer(RENTGRS ~ INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + FTOTINC + (1 | REGION_CLASSIFIED), data = data_twenty, REML = FALSE)
```

```{r}
model_glance <- broom.mixed::glance(model)

model_tidy <- broom.mixed::tidy(model)

model_augment <- broom.mixed::augment(model)
```

```{r}
print(model_glance)
print(model_tidy)
print(head(model_augment))
```

```{r}
# Calculate residuals and fitted values
residuals_twenty <- resid(model_with_income)
fitted_values_twenty <- fitted(model_with_income)

# Create a residual plot
plot(fitted_values_twenty, residuals_twenty, 
     xlab = "Fitted Values", ylab = "Residuals",
     main = "Residual Plot", pch = 20)
abline(h = 0, col = "red") 
```




```{r}
# Filter out non-positive values before log transformation
data_twenty <- data_twenty[data_twenty$RENTGRS > 0 & data_twenty$INCTOT > 0, ]

# Apply log transformation
data_twenty$log_RENTGRS <- log(data_twenty$RENTGRS)
data_twenty$log_INCTOT <- log(data_twenty$INCTOT)


# Calculating means and standard deviations for the log-transformed columns
mean_log_RENTGRS <- mean(data_twenty$log_RENTGRS, na.rm = TRUE)
sd_log_RENTGRS <- sd(data_twenty$log_RENTGRS, na.rm = TRUE)
mean_log_INCTOT <- mean(data_twenty$log_INCTOT, na.rm = TRUE)
sd_log_INCTOT <- sd(data_twenty$log_INCTOT, na.rm = TRUE)


# Defining lower and upper bounds for both variables
lb_log_RENTGRS <- mean_log_RENTGRS - 3 * sd_log_RENTGRS
ub_log_RENTGRS <- mean_log_RENTGRS + 3 * sd_log_RENTGRS
lb_log_INCTOT <- mean_log_INCTOT - 3 * sd_log_INCTOT
ub_log_INCTOT <- mean_log_INCTOT + 3 * sd_log_INCTOT

# Filtering out outliers
data_twenty_clean <- data_twenty[data_twenty$log_RENTGRS >= lb_log_RENTGRS & data_twenty$log_RENTGRS <= ub_log_RENTGRS & 
                             data_twenty$log_INCTOT >= lb_log_INCTOT & data_twenty$log_INCTOT <= ub_log_INCTOT, ]
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_with_income_log <- lmer(log_RENTGRS ~ log_INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + FTOTINC + (1 | REGION_CLASSIFIED), data = data_twenty_clean, REML = FALSE)
```

### Residual plot
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate residuals and fitted values
residuals_2022 <- resid(model_with_income_log)
fitted_values_2022 <- fitted(model_with_income_log)

# Create a residual plot
plot(fitted_values_2022, residuals_2022, 
     xlab = "Fitted Values", ylab = "Residuals",
     main = "Residual Plot", pch = 20)
abline(h = 0, col = "red") 
```




