---
title: "Analysis"
description: "Here we provide a detailed analysis using more sophisticated statistics techniques."
draft: false
runtime: shiny
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(shiny)
library(DT)
library(tidyr)
library(broom)
library(dplyr)
library(here)
library(gt)
library(purrr)
library(readr)
library(ggplot2)
library(knitr)
library(lme4)
library(broom.mixed)
library(kableExtra)

data_path <- here("dataset", "data_twenty_clean.csv")
data_path1 <- here("dataset", "latest_clean.csv")

data_twenty <- read_csv(data_path,show_col_types = FALSE) 
data_2022 <- read_csv(data_path1,show_col_types = FALSE) 

```

# Research Question and Motivation

## Motivation

The primary focus of this research is to investigate the relationship between individual income levels and rental expenditures. This analysis is motivated by the need to understand the financial burdens of rent relative to income and how this impacts different demographic groups over time.

## Objectives

-   **Relationship Exploration**: We aim to determine how changes in income levels affect rental spending. This includes examining whether the relationship is strictly linear or if there are nonlinear dynamics that better capture the fluctuations in rental expenditures as income varies.
-   **Quantitative Analysis**: Our goal is to quantify the relationship precisely. For example, we seek to estimate the increase in rental expenditure for every thousand-dollar increase in income or the percentage change of rent expenditure for every one percent increase in income.
-   **Demographic Variance**: The study will also consider racial differences to identify how income's impact on rent varies among different racial groups.
-   **Temporal Analysis**: Employing a time series regression model allows us to account for changes over time, providing a dynamic perspective on the income-rent relationship.

## Key Questions

-   What is the quantitative impact of income changes on rental expenditures?
-   How does the relationship between income and rent vary across different racial groups?
-   Does the relationship between income and rent change over time?

# Models and Inferences (First dataset)

## Outline

1.  Simple Linear Regression Model (Detailed in Class Blog 4)
2.  Multiple Linear Regression Model (Detailed in Class Blog 4)
3.  Log-Log Regression Model
4.  Log-Log Regression Model with interaction terms

## 1. Simple Linear Regression Model

### Model Overview:

This model investigates the relationship between income (the predictor) and rent (the response), offering preliminary insights into whether they share a positive or negative correlation and assessing if it is worth to have further detailed analysis.

### Model Findings:

```{r echo=FALSE, message=FALSE, warning=FALSE}
lm_model <- lm(RENTGRS ~ INCTOT, data = data_2022)
tidy_lm <- tidy(lm_model)
kable(tidy_lm, format = "pipe")
```

-   The model suggests that an increase of \$1,000 in income is associated with an average increase of approximately 5.7 dollars in the rent variable.

### Statistical Performance:

```{r echo=FALSE, message=FALSE, warning=FALSE}
glance_lm <- glance(lm_model)
kable(glance_lm, format = "pipe")
```

-   The model's R-squared and adjusted R-squared values are modest but acceptable for simple linear regression, justifying further exploration.

-   A significant F-statistic and p_value confirm the model's statistical relevance, despite a high sigma pointing to considerable unexplained variance.

### Model Discussion:

-   The model offers an initial look at the income-rent relationship but is incomplete.
-   Future analysis should incorporate more factors for greater accuracy.

## 2. Multiple Linear Regression Model

### Model Overview:

-   This model enhances the simple linear regression by incorporating additional confounding variables to refine our analysis.
-   This expanded model builds upon the initial simple linear regression framework.

### Model Findings:

```{r echo=FALSE, message=FALSE, warning=FALSE}
ui <- fluidPage(
   titlePanel(tags$h1("Model Summary Table_MLR Model", style = "font-size: 18px;")),
  sidebarLayout(
    sidebarPanel(
      selectInput("variable", "Select Variable:", choices = NULL),
      hr(),
      p("The analysis reveals that one thousand dollar increase in total income (INCTOT) is associated with an average increase of 5.5 in gross rent (RENTGRS), assuming other variables are constant.")
    ),
    mainPanel(
      uiOutput("modelTable") 
    )
  )
)

server <- function(input, output, session) {
  mlr_model <- lm(RENTGRS ~ INCTOT + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + REGION_CLASSIFIED, data = data_2022)
  tidy_mlr <- tidy(mlr_model)
  observe({
    updateSelectInput(session, "variable", 
                      choices = tidy_mlr$term,
                      selected = "INCTOT")  # Default to INCTOT
  })

  output$modelTable <- renderUI({
    selected_var <- input$variable
    if (is.null(selected_var)) {
      selected_var <- "INCTOT"
    }
    selected_row <- tidy_mlr %>% filter(term == selected_var)
    kable(selected_row, "html") %>%
      kable_styling(bootstrap_options = "striped", full_width = FALSE) %>%
      as.character() %>%
      HTML()
  })
}

shinyApp(ui = ui, server = server)

```

### Variable Selection and model refinement:

-   A correlation matrix was used to identify control variables and to detect potential multi-collinearity issues.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_2022$KITCHEN <- as.factor(data_2022$KITCHEN)
data_2022$MARST <- as.factor(data_2022$MARST)
data_2022$RACE <- as.factor(data_2022$RACE)
data_2022$EMPSTAT <- as.factor(data_2022$EMPSTAT)
data_2022$REGION_CLASSIFIED <- as.factor(data_2022$REGION_CLASSIFIED)
cor_matrix <- cor(data_2022[, c("INCTOT", "ROOMS", "NFAMS", "AGE", "FTOTINC", "RENTGRS")])
kable(cor_matrix, format = "pipe")
```

-   After fitting the multiple linear regression (MLR) model, `Kitchen` was removed due to its statistical insignificance, indicated by a high p-value. `Employment Status`, although not as critical, also showed a non-significant p-value and is suspected to interact with variables like `Income` or `FTOTINC`. This interaction will be explored further.
-   A review of multicollinearity prompted the removal of `FTOTINC` to prevent model overfitting.

```{r echo=FALSE, message=FALSE, warning=FALSE}
mlr_model <- lm(RENTGRS ~ INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + FTOTINC + REGION_CLASSIFIED, data = data_2022)
library(car)
vif_values <- vif(mlr_model)
kable(vif_values)
```

-   The selection and validation of control variables were systematically conducted.
-   After fitting the multiple linear regression (MLR) model, `Kitchen` was removed due to its statistical insignificance, indicated by a high p-value.
-   `Employment Status`, although not as critical, also showed a non-significant p-value and is suspected to interact with variables like `Income` or `FTOTINC`. This interaction will be explored further.
-   A review of multicollinearity prompted the removal of `FTOTINC` to prevent model overfitting.

-   The selection and validation of control variables were systematically conducted.

### Statistical Performance:
```{r echo=FALSE, message=FALSE, warning=FALSE}
glance_mlr=glance(mlr_model)
kable(glance_mlr)
```
-   The R-squared value of 0.28 indicates that approximately 28% of the variance in the dependent variable (gross rent) is explained by the model, which is a considerable improvement compared to the simple linear regression.
-   The adjusted R-squared value of 0.2807292 closely mirrors the R-squared value, suggesting that the additional predictors are effectively contributing valuable information.
-   A F-statistic value of 98.57 and a p-value of 0 confirm the statistical significance of the model, suggesting that the regression results are highly unlikely to occur by chance.

### Model Discussion :
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Fit the model
residuals <- resid(mlr_model)
fitted_values <- fitted(mlr_model)

plot(fitted_values, residuals,
     xlab = "Fitted Values",
     ylab = "Residuals",
     main = "Residual Plot of mlr_model",
     pch = 20)

abline(h = 0, col = "red")
```

- The pattern in this plot suggests potential non-linear relationships and heteroscedasticity as the systematic pattern seen here where residuals create a fan-shaped spread. 
- There are some points that stand out from the cloud of points, especially on the bottom left and the top right of the plot. These could be potential outliers or leverage points.
- Given the apparent increase in variability of residuals with the size of the fitted values and the non-linear pattern, applying a log transformation to the variable might help. 

## 3. Log-Log Regression Model

### Model Overview:
-   Predictor and response variables underwent log transformation to correct for right skewness, as elaborated on the data page and the discussion in last section.
-   A reanalysis was conducted post data cleansing to assess the impact of log-transformed variables.

### Model Findings:

```{r echo=FALSE, message=FALSE, warning=FALSE}
log_model_2022 <- lm(log_RENTGRS ~ log_INCTOT + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + REGION_CLASSIFIED, data = data_2022)
ui <- fluidPage(
 titlePanel(tags$h1("Model Summary Table_log_log Model", style = "font-size: 18px;")),  
  sidebarLayout(
    sidebarPanel(
      selectInput("variable", "Select Variable:", choices = NULL),
      hr(),
      p("The model suggests that a 10% increase in income is predicted to raise rent by an average of 13.34%, with all other variables held constant, indicating income's elasticity effect on rent.")
    ),
    mainPanel(
      DTOutput("modelTable")
    )
  )
)

server <- function(input, output, session) {
  data_2022$log_INCTOT <- log(data_2022$INCTOT + 1)  
  data_2022$log_RENTGRS <- log(data_2022$RENTGRS + 1)  
  log_model_2022 <- lm(log_RENTGRS ~ log_INCTOT + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + REGION_CLASSIFIED, data = data_2022)
  tidy_log_model_2022 <- tidy(log_model_2022)
  observe({
    vars <- tidy_log_model_2022$term
    default_selection <- "log_INCTOT"
    if (default_selection %in% vars) {
      updateSelectInput(session, "variable", choices = vars, selected = default_selection)
    } else {
      updateSelectInput(session, "variable", choices = vars, selected = vars[1])
    }
  })
  output$modelTable <- renderDT({
    req(input$variable)  # Ensure that input$variable is reactive and triggers the rendering
    selected_row <- tidy_log_model_2022 %>% filter(term == input$variable)
    datatable(selected_row, options = list(pageLength = 5, autoWidth = TRUE))
  })
}
shinyApp(ui = ui, server = server)
```


### Statistical Performance:
```{r echo=FALSE, message=FALSE, warning=FALSE}
glance_log=glance(log_model_2022)
kable(glance_log)
```
-   An adjusted R-squared value of 0.223, while modest, is considered adequate within the complex realms of social science and economics.
-   A very low p-value signifies the statistical significance of the model’s predictors.
-   The sigma value's reduction points to a more precise model, albeit comparisons with non-logarithmic models are not straightforward due to scale differences.

### Model Discussion:
1.  Linearity and Homoscedasticity:
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(fitted(log_model_2022), residuals(log_model_2022),
     xlab = "Fitted values",
     ylab = "Residuals",
     main = "Residuals vs. Fitted Values")
abline(h = 0, col = "red")
```

-   The absence of a systematic pattern in the residuals indicates a proper capture of the relationship between the predictors and response variable in the log-transformed model.
-   The spread of residuals is mostly consistent, though some widening at the extremes suggests minor heteroscedasticity. This is often a minor issue in economic data, reflecting the variability in higher income or rent brackets, and doesn't significantly affect the model's overall validity.
-   Residuals predominantly centering around the zero line signify no model bias, reinforcing the model's accuracy.
-   A small number of potential outliers deviate from the main cluster, which is typical in large economic datasets and generally does not markedly impact the robust central trend captured by the model.

2.  Normality of Residuals:

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Q-Q plot of residuals
qqnorm(residuals(log_model_2022))
qqline(residuals(log_model_2022), col = "steelblue")
```

-   The bulk of residuals align with the normality line on the Q-Q plot, with slight deviations at both ends.
-   These deviations, often seen in economic data due to outliers, do not substantially affect the model’s predictive capability.

3.  IID Errors:

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(lmtest)
test <- dwtest(log_model_2022)
kable(tibble::as_tibble(list(
  Statistic = test$statistic,
  p_Value = test$p.value
)), caption = "Durbin-Watson Test Results")
```

-   For Durbin-Watson Statistic, the result statistic value close to 2 indicates no autocorrelation, implying that the errors are independent. And for a random scatter of residuals, without visible trends or cycles, supports the assumption of IID errors.

4.  Multicollinearity:

```{r echo=FALSE, message=FALSE, warning=FALSE}
index=vif(log_model_2022)
kable(index)
```

-   The adjusted GVIF values, being all near or below the threshold of 1.5 after taking the root, demonstrate that the multicollinearity is likely not distorting the estimates in the regression model significantly. This implies that each predictor variable is providing unique information that is not overly redundant with other variables in the model.

**Upon reviewing these diagnostic measures, the model is deemed well-fitted, and the derived conclusions are robust and reliable.**

## 4. Log-Log Regression Model by Race

### Model Overview

-   This analysis applies a stratified Log-Log regression approach, segregating data by race as detailed in Class Blog 6. It builds upon the strong foundational understanding from Section 3.

### Model Findings:

```{r echo=FALSE, message=FALSE, warning=FALSE}
categorical_vars <- c("KITCHEN", "MARST", "EMPSTAT", "REGION_CLASSIFIED")
data_2022[categorical_vars] <- lapply(data_2022[categorical_vars], factor)
categorical_vars <- c("KITCHEN", "MARST", "EMPSTAT", "REGION_CLASSIFIED")
data_2022[categorical_vars] <- lapply(data_2022[categorical_vars], factor)
race_levels <- data_2022 %>%
  group_by(RACE) %>%
  summarize(across(all_of(categorical_vars), ~n_distinct(.))) %>%
  ungroup()
races_with_single_levels <- race_levels %>%
  filter(if_any(everything(), ~.x == 1)) %>%
  pull(RACE) 
data_2022_filtered <- data_2022 %>%
  filter(!RACE %in% races_with_single_levels)

models_by_race <- data_2022_filtered%>%
  group_by(RACE) %>%
  do(
    model = lm(log_RENTGRS ~ log_INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + EMPSTAT + REGION_CLASSIFIED, data = .)
  )

models_summaries <- models_by_race %>%
  rowwise() %>%
  do(
    tidy_model = broom::tidy(.$model)
  )
unnested_models_summaries <- tidyr::unnest(models_summaries, tidy_model)

inctot_coefficients_by_race <- models_by_race %>%
  rowwise() %>%
  summarize(
    RACE = unique(RACE),
    log_INCTOT_Coefficient = coef(model)["log_INCTOT"]
  )
kable(inctot_coefficients_by_race)
```

-   The coefficient for log_INCTOT shows notable variation across racial categories, which indicates the impact of income on rent varies by race.

-   The Chinese group demonstrates the highest log_INCTOT coefficient, indicating a particularly strong positive association between income and rent within this demographic.

-   American Indian or Alaska Native, Other Asian or Pacific Islander, Other race, nec, Three or more major races, and White categories show a range of coefficients, suggesting varied levels of positive association.

-   Black/African American and Two major races groups present with lower coefficients, hinting at a relatively weaker positive relationship.

### Statistical Performance:

```{r echo=FALSE, message=FALSE, warning=FALSE}
models_summaries <- data_2022_filtered %>%
  group_by(RACE) %>%
  do(
    tidy_model = broom::tidy(lm(log_RENTGRS ~ log_INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + EMPSTAT + REGION_CLASSIFIED, data = .))
  ) %>%
  unnest(tidy_model) %>%
  filter(term == "log_INCTOT") %>%
  select(RACE, term, estimate, p.value) %>%
  arrange(RACE)
kable(models_summaries)
```

-   For most racial groups, the p-values indicate statistical significance (p \< 0.05), especially pronounced for `Black/African American`, `Chinese`, `Other Asian or Pacific Islander`, and `White categories`, implying a strong relationship between income and rent.

-   The higher p-value for `American Indian or Alaska Native` suggests that the relationship between income and rent is **not statistically significant** for this group, based on the traditional alpha threshold.

### Model Discussion:

-   The evident variability in log_INCTOT coefficients across races suggests that the relationship between income and rent is influenced by racial factors, pointing towards the complexity inherent in socio-economic dynamics.

-   Non-significance in certain racial categories may reflect data limitations or the presence of other variables not captured in the model, indicating areas where further research or data collection could be beneficial.

-   The model's overall robustness and the significance of its findings provide valuable insights, yet also suggest that an exploration of additional socio-economic factors and historical trends could contribute to a more nuanced understanding.

## 5. Enhanced Log-Log Regression Model with Interaction Terms 
### Model Overview

-  This model is built upon the solid foundation established in Section 3. We're now exploring nonlinearity further and addressing the potential skewness identified in the conclusions of Model 3.

### Model Overview and Model Refinement:

-   The interaction term `EMPSTAT * FTOTINC` has been introduced to investigate the suspected interaction effect between employment status and total family income.

-   Post inclusion, the p-value for `EMPSTATUnemployed:FTOTINC` is slightly above 0.05, suggesting it has borderline statistical significance.

```{r echo=FALSE, message=FALSE, warning=FALSE}
server <- function(input, output, session) {
  output$modelTable <- renderDT({
    req(models_by_year)
    year_data <- models_by_year %>%
      filter(YEAR == input$yearSlider)
    year_data <- year_data %>%
      mutate(
        estimate = map_dbl(tidied, ~ .x$estimate[.x$term == "log_INCTOT"]),  
        std_error = map_dbl(tidied, ~ .x$std.error[.x$term == "log_INCTOT"]),
        statistic = map_dbl(tidied, ~ .x$statistic[.x$term == "log_INCTOT"]),
        p_value = map_dbl(tidied, ~ .x$p.value[.x$term == "log_INCTOT"]) 
      ) %>%
      select(YEAR, estimate, std_error, statistic, p_value)  
    datatable(year_data, 
      options = list(
        pageLength = 1,      
        lengthMenu = c(1, 5, 10, 25, 50, 100),
        autoWidth = TRUE
      ),
      rownames = FALSE
    )
  })
}
```



### Statistical Performance:
```{r echo=FALSE, message=FALSE, warning=FALSE}
data_2022$FTOTINC = data_2022$FTOTINC - data_2022$INCTOT

log_model_2022 <- lm(log_RENTGRS ~ log_INCTOT + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT*FTOTINC + REGION_CLASSIFIED, data = data_2022)
glance_log_model_2022 <- glance(log_model_2022)
kable(glance_log_model_2022)
```
-   All predictors show statistical significance, with the exception of certain categories within marital status and employment status, indicating robustness in the variable selection.

-   The integration of the interaction term retains the significance of other variables, with no detrimental impact on the model’s variables as reflected in their p-values.

### Model Discussion:

- The residual plot indicates that the model without interaction terms performs better than the log-log regression with interaction terms. Even when the model includes interaction terms, the residuals should still be randomly dispersed around the zero line on the y-axis to meet the assumptions of homoscedasticity and no autocorrelation.

```{r echo=FALSE, message=FALSE, warning=FALSE}
residuals_2022 <- resid(log_model_2022)
fitted_values_2022 <- fitted(log_model_2022)

plot(fitted_values_2022, residuals_2022, 
     xlab = "Fitted Values", ylab = "Residuals",
     main = "Residual Plot", pch = 20)
abline(h = 0, col = "red") 
```

**Therefore, although this model's conclusions offer an extension to our understanding of the economic factors influencing rent prices in section 3, we still take the log_log model for further analysis.**

# Models and Inferences (Merged dataset)

## Outline

1.  Log-Log Regression Model by YEAR
2.  Longitudinal Log-Log Regression Model by Race
3.  Time series model

## 1. Log-Log Regression Model by YEAR

### Model Overview:

-   This analysis implements the validated Log-Log regression approach on annual data segments to assess temporal trends and variations.

### Model Findings:
```{r echo=FALSE, message=FALSE, warning=FALSE}
models_by_year <- data_twenty %>%
  group_by(YEAR) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(log_RENTGRS ~ log_INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + REGION_CLASSIFIED, data = .)),
    tidied = map(model, tidy),
    glance_data = map(model, glance),
    augmented = map(model, augment)
  ) %>%
  ungroup()
models_by_year %>%
  unnest(tidied) %>%
  filter(term == "log_INCTOT") %>%
  ggplot(aes(x = as.numeric(YEAR), y = estimate)) +
  geom_line() +
  geom_point() +
  labs(title = "Trend of Coefficient for log_INCTOT Over Years",
       x = "Year",
       y = "Coefficient Estimate")
```

-   Observations show peaks in coefficient estimates, notably after 2000 and before 2020, with subsequent troughs suggesting potential corrective periods.
- The coefficient shows dropping down during the Covid-19 period.
-   The coefficient trend exhibits cyclicity with no monotonic progression, featuring multiple peaks and valleys, implying a potential cyclical influence on the income-rent relationship.
-   Coefficient estimates range within a tight interval, indicating a consistent strength of relationship across the dataset's timespan.

```{r echo=FALSE, message=FALSE, warning=FALSE}
models_by_year <- data_twenty %>%
  group_by(YEAR) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(log_RENTGRS ~ log_INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + RACE + EMPSTAT + REGION_CLASSIFIED, data = .)),
    tidied = map(model, tidy),
    glance_data = map(model, glance)  # Ensure this line correctly creates glance_data
  ) %>%
  ungroup()

if ("glance_data" %in% names(models_by_year)) {
  # If glance_data exists, proceed with the visualization
  r_squared_trends <- models_by_year %>%
    select(YEAR, glance_data) %>%
    unnest(cols = glance_data) %>%
    ggplot(aes(x = as.numeric(YEAR), y = r.squared)) +
    geom_line() +
    geom_point() +
    labs(title = "Trend of R-squared Over Years",
         x = "Year",
         y = "R-squared")

  print(r_squared_trends)
} else {
  cat("Error: 'glance_data' column does not exist. Check model fitting and glance data generation steps.\n")
}

```

-   R-squared values demonstrate time-bound variability, implying shifts in the model's explanatory power from year to year.
-   A recent sharp decline in R-squared highlights a potential reduction in predictive accuracy or a substantial data structure change.

### Statistical Performance:

```{r echo=FALSE, message=FALSE, warning=FALSE}
ui <- fluidPage(
  titlePanel("Model Summary Statistics by Year"),
  sidebarLayout(
    sidebarPanel(
      # Ensure years are sorted in descending order
      selectInput("year", "Choose a year:", choices = sort(unique(models_by_year$YEAR), decreasing = TRUE))
    ),
    mainPanel(
      DTOutput("model_summary_table")  # Use DTOutput for data tables
    )
  )
)

server <- function(input, output) {
  output$model_summary_table <- renderDT({
    req(models_by_year) 
    year_data <- models_by_year %>%
      filter(YEAR == input$year)
    year_data <- year_data %>%
      select(YEAR, glance_data) %>%
      unnest(cols = glance_data) %>%
      arrange(YEAR) %>%
      select(YEAR, r.squared, adj.r.squared, sigma, statistic, p.value, df, logLik, AIC, BIC, deviance, df.residual, nobs) 
    datatable(year_data, 
      options = list(
        pageLength = 10,      
        lengthMenu = c(5, 10, 25, 50, 100),
        autoWidth = TRUE
      ),
      rownames = FALSE
    )
  })
}

shinyApp(ui = ui, server = server)
```

-   All models are statistically validated, while reviewing each coefficient of each year through 'tidy' table, there is a noticeable exception in the MARSTSeparated category for the year 2022 shows to be statistically insiginificant, but others are all good .
-   R-squared values exhibit minor fluctuations over time, signifying a stable degree of explained variability in the response variable by the model.
-   Adjusted R-squared values, marginally lower than the R-squared, adhere to expectations, considering model complexity relative to data volume.
-   P-values indicate consistent statistical significance for the model's predictors on an annual basis.
-   Log-likelihood, AIC, and BIC values increment over time, which may indicate an improving model fit or increasing data variability.
-   The trends in model deviance require additional context for clear interpretation, while a gradual decrease in df.residual suggests either an increase in model parameters or variations in data availability over time.

## 2. Longitudinal Log-Log Regression Model by Race

### Model Overview:

-   This model extended the 2022 dataset analysis to explore how the rent-income relationship for each racial group has evolved from 2000 to 2022.
-   Trends over time for each race were charted to illustrate these dynamics.
-   Similar to the 2022 model, the coefficients were found to be statistically significant and the residual plots falling within an acceptable range.

### Model Findings:

```{r echo=FALSE, message=FALSE, warning=FALSE}
categorical_vars <- c("KITCHEN", "MARST", "EMPSTAT", "REGION_CLASSIFIED")
data_twenty[categorical_vars] <- lapply(data_twenty[categorical_vars], factor)

categorical_vars <- c("KITCHEN", "MARST", "EMPSTAT", "REGION_CLASSIFIED")
data_twenty[categorical_vars] <- lapply(data_twenty[categorical_vars], factor)

race_levels <- data_twenty %>%
  group_by(RACE) %>%
  summarize(across(all_of(categorical_vars), ~n_distinct(.))) %>%
  ungroup()
races_with_single_levels <- race_levels %>%
  filter(if_any(everything(), ~.x == 1)) %>%
  pull(RACE) 
data_twenty_filtered <- data_twenty %>%
  filter(!RACE %in% races_with_single_levels)

data_twenty_filtered[categorical_vars] <- lapply(data_twenty_filtered[categorical_vars], factor)

race_year_levels <- data_twenty_filtered %>%
  group_by(RACE, YEAR) %>%
  summarize(across(all_of(categorical_vars), ~n_distinct(.))) %>%
  ungroup()

race_year_with_single_levels <- race_year_levels %>%
  filter(if_any(everything(), ~.x == 1)) 

data_twenty_filtered_final <- data_twenty_filtered %>%
  anti_join(race_year_with_single_levels, by = c("RACE", "YEAR"))

models_by_race_year <- data_twenty_filtered_final %>%
  group_by(RACE, YEAR) %>%
  do(
    model = lm(log_RENTGRS ~ log_INCTOT + KITCHEN + ROOMS + NFAMS + AGE + MARST + EMPSTAT + REGION_CLASSIFIED, data = .)
  )

models_with_coef <- models_by_race_year %>%
  rowwise() %>% 
  mutate(log_INCTOT_coef = coef(model)[["log_INCTOT"]]) %>%
  ungroup() %>%
  select(RACE, YEAR, log_INCTOT_coef)

coefficients_wide <- models_with_coef %>%
  pivot_wider(names_from = RACE, values_from = log_INCTOT_coef, names_prefix = "coef_")

kable(coefficients_wide)
```

-   Specific Trends:

**Alaska Native**: Shows minor fluctuations around zero, with both positive and negative coefficients, indicating inconsistent trends over the years.

**American**: This category has NA values, suggesting incomplete data, making it hard to discern a clear trend.

**Chinese**: Generally has higher positive coefficients compared to other groups, particularly noticeable in later years, indicating a strong positive association with income in those years.

**Japanese**: Has some missing values but otherwise presents mostly positive coefficients, with a notable spike in recent years.

**Islander**: Also features both positive and negative coefficients with considerable variability.

**Other race, nec**: Shows a mix of positive, negative, and NA values, making a clear trend difficult to establish.

**Two or more races**: This group generally has positive coefficients, with a few exceptions, suggesting a fairly consistent positive association with income.

**Whites**: Present a range of coefficients, mostly positive with some fluctuations, but generally indicate a positive association with income.

-   Race Comparisons: Certain racial categories, like those identifying as Chinese and Japanese, tend to have higher coefficients, suggesting a stronger relationship with income than other races in the dataset. Conversely, the 'Other race, nec' category often has lower coefficients, implying a weaker association with income.

```{r echo=FALSE, message=FALSE, warning=FALSE}
coefficients_long <- coefficients_wide %>%
  pivot_longer(cols = -YEAR, names_to = "RACE", values_to = "log_INCTOT_coef")

unique_races <- unique(coefficients_long$RACE)

bar_color <- "#2C3E50" 
plots_list <- list()
for (race in unique_races) {
  race_data <- subset(coefficients_long, RACE == race)
  
  p <- ggplot(race_data, aes(x = as.factor(YEAR), y = log_INCTOT_coef)) +
    geom_bar(stat = "identity", fill = bar_color, width = 0.7) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), 
          plot.title = element_text(hjust = 0.5, face = "bold")) + 
    labs(title = paste("Income Coefficient:", race),
         x = "Year",
         y = "Coefficient")
  plots_list[[race]] <- p
}
coefficients_long <- coefficients_wide %>%
  pivot_longer(cols = -YEAR, names_to = "RACE", values_to = "log_INCTOT_coef")

unique_races <- unique(coefficients_long$RACE)

ui <- fluidPage(
  titlePanel("Income Coefficients by Race"),
  sidebarLayout(
    sidebarPanel(
      selectInput("selected_race", "Choose a race:", choices = unique_races)
    ),
    mainPanel(
      plotOutput("race_plot")
    )
  )
)
server <- function(input, output) {
  selected_data <- reactive({
    coefficients_long %>%
      filter(RACE == input$selected_race)
  })
  
  output$race_plot <- renderPlot({
    data <- selected_data()  
    ggplot(data, aes(x = as.factor(YEAR), y = log_INCTOT_coef)) +
      geom_bar(stat = "identity", fill = "#2C3E50", width = 0.7) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), 
            plot.title = element_text(hjust = 0.5, face = "bold")) +
      labs(title = paste("Income Coefficient:", input$selected_race),
           x = "Year",
           y = "Coefficient")
  })
}
shinyApp(ui = ui, server = server)
```

### Statistical Performance:
```{r echo=FALSE, message=FALSE, warning=FALSE}
ui <- fluidPage(
  titlePanel("INCTOT Coefficients Analysis by Race"),
  sidebarLayout(
    sidebarPanel(
      # Ensure no prefix like "coef_" in race names unless absolutely needed
      selectInput("selected_race", "Choose a race:", choices = unique(log_inctot_p_values$RACE))
    ),
    mainPanel(
      dataTableOutput("filtered_data")
    )
  )
)

server <- function(input, output) {
  # Create a reactive expression that filters the data based on the selected race
  filtered_data <- reactive({
    # Debug: Print selected race to see what's being received
    print(paste("Selected race:", input$selected_race))
    
    filtered <- log_inctot_p_values %>%
      filter(RACE == input$selected_race)
    
    # Debug: Print the number of rows after filtering
    print(paste("Rows after filter:", nrow(filtered)))

    if(nrow(filtered) == 0) {
      print(unique(log_inctot_p_values$RACE))
    }
    
    filtered
  })
  
  # Render the table output
  output$filtered_data <- renderDataTable({
    dt <- filtered_data()
    if (is.data.frame(dt) && nrow(dt) > 0) {
      datatable(dt, options = list(pageLength = 10, autoWidth = TRUE))
    } else {
      # Return an empty data frame with the correct columns if no data to avoid error
      datatable(data.frame(RACE=character(), YEAR=integer(), term=character(), estimate=numeric(), p.value=numeric()),
                options = list(pageLength = 10, autoWidth = TRUE))
    }
  })
}


shinyApp(ui = ui, server = server)

```


### Discussion of the topic: Race is really a point that needs to explore. Thorugh the result and the visualization of the coefficient changes for each race, there is defintely different pattens showed.

## 3.Time series model

------------------------------------------------------------------------
